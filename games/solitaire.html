<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solitaire Classic Pro | GameHub Pro</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .game-wrapper {
            max-width: 1000px;
            margin: 40px auto;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            min-height: 700px;
        }

        .stats-bar {
            padding: 15px 40px;
            background: rgba(124, 77, 255, 0.1);
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            font-weight: 800;
            border-bottom: 1px solid var(--glass-border);
        }

        .stat-val {
            color: var(--accent-secondary);
            margin-left: 5px;
            font-size: 18px;
        }

        .game-body {
            position: relative;
            background: radial-gradient(circle at center, #06402b, #002211);
            flex-grow: 1;
            padding: 20px;
        }

        /* Card Styles */
        .card {
            width: 80px;
            height: 112px;
            background: #fff;
            border-radius: 6px;
            position: absolute;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 5px;
            user-select: none;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .card:hover {
            filter: brightness(1.1);
        }

        .card.selected {
            box-shadow: 0 0 10px #ffff00;
            transform: translateY(-5px);
            z-index: 100 !important;
        }

        .card.back {
            background: linear-gradient(135deg, #b71c1c, #d32f2f);
            border: 2px solid #fff;
        }

        .card.back::after {
            content: '♦';
            color: rgba(255, 255, 255, 0.2);
            font-size: 48px;
        }

        .card.red {
            color: #d00;
        }

        .card.black {
            color: #000;
        }

        .card-top,
        .card-bottom {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
        }

        .card-bottom {
            transform: rotate(180deg);
        }

        .card-center {
            font-size: 32px;
        }

        /* Slots */
        .slot {
            position: absolute;
            width: 80px;
            height: 112px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 6px;
        }

        .foundation-area {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 360px;
            height: 120px;
        }

        .tableau-area {
            position: absolute;
            top: 150px;
            left: 20px;
            width: 100%;
            height: 500px;
        }

        .deck-area {
            position: absolute;
            top: 20px;
            left: 20px;
        }

        #foundation0 {
            left: 0;
        }

        #foundation1 {
            left: 90px;
        }

        #foundation2 {
            left: 180px;
        }

        #foundation3 {
            left: 270px;
        }

        .win-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
    </style>
</head>

<body class="dark-theme">
    <header class="main-header" style="position: relative; background: transparent; border: none;">
        <div class="nav-container">
            <a href="../index.html" class="logo" style="text-decoration: none; color: inherit;">
                <i data-lucide="arrow-left"></i>
                <span>BACK TO <span class="accent-text">HUB</span></span>
            </a>
            <h2 style="font-weight:800; letter-spacing:-1px">SOLITAIRE CLASSIC PRO</h2>
        </div>
    </header>

    <div class="game-wrapper">
        <div class="stats-bar">
            <span>SCORE: <span class="stat-val" id="score">0</span></span>
            <span>MOVES: <span class="stat-val" id="moves">0</span></span>
        </div>

        <div class="game-body" id="gameTable">
            <div class="deck-area">
                <div class="slot" id="stockSlot" onclick="game.drawStock()"></div>
                <div class="slot" id="wasteSlot" style="left: 100px;"></div>
                <button class="btn-secondary" onclick="game.showHint()"
                    style="position:absolute; left:220px; top:10px; padding:8px 15px; font-size:12px">AI HINT</button>
            </div>

            <div class="foundation-area">
                <div class="slot" id="foundation0" onclick="game.clickFoundation(0)"></div>
                <div class="slot" id="foundation1" onclick="game.clickFoundation(1)"></div>
                <div class="slot" id="foundation2" onclick="game.clickFoundation(2)"></div>
                <div class="slot" id="foundation3" onclick="game.clickFoundation(3)"></div>
            </div>

            <div class="tableau-area" id="tableauContainer">
                <!-- Generated by JS -->
            </div>

            <div class="win-screen" id="winScreen">
                <h1 style="font-size:48px; color:var(--accent-primary); margin-bottom:20px">SOLITAIRE COMPLETE</h1>
                <button class="btn-primary" onclick="location.reload()">PLAY AGAIN</button>
            </div>
        </div>
    </div>

    <script src="../js/shared.js"></script>
    <script>
        lucide.createIcons();

        const SUITS = ['♠', '♥', '♣', '♦']; // 0-3
        const COLORS = ['black', 'red', 'black', 'red'];
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

        class Solitaire {
            constructor() {
                this.deck = [];
                this.stock = [];
                this.waste = [];
                this.foundations = [[], [], [], []];
                this.tableau = [[], [], [], [], [], [], []];

                this.selected = null; // { type: 'tableau'|'waste', col: index, index: cardIndex }
                this.score = 0;
                this.moves = 0;

                this.init();
            }

            init() {
                // Create Deck
                SUITS.forEach((s, si) => {
                    RANKS.forEach((r, ri) => {
                        this.deck.push({ suit: s, rank: r, val: ri + 1, color: COLORS[si], faceUp: false });
                    });
                });

                // Shuffle
                for (let i = this.deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
                }

                // Deal Tableau
                for (let i = 0; i < 7; i++) {
                    for (let j = 0; j <= i; j++) {
                        let c = this.deck.pop();
                        if (j === i) c.faceUp = true;
                        this.tableau[i].push(c);
                    }
                }

                this.stock = [...this.deck];
                this.render();
            }

            // --- Logic ---

            drawStock() {
                if (this.stock.length === 0) {
                    if (this.waste.length === 0) return;
                    // Recycle waste
                    this.stock = this.waste.reverse().map(c => ({ ...c, faceUp: false }));
                    this.waste = [];
                    this.score = Math.max(0, this.score - 50);
                } else {
                    let c = this.stock.pop();
                    c.faceUp = true;
                    this.waste.push(c);
                }
                this.selected = null;
                this.addMove();
                this.render();
            }

            clickCard(type, colIdx, cardIdx) {
                // Logic:
                // If nothing selected, select this (must be faceUp).
                // If something selected:
                //   Try to move selected TO this.
                //   If valid move, execute.
                //   If invalid, select this instead.

                let card = null;
                if (type === 'waste') card = this.waste[this.waste.length - 1];
                else if (type === 'tableau') card = this.tableau[colIdx][cardIdx];

                if (!card) return; // Should not happen on click

                if (!card.faceUp) {
                    // Only top of tableau can be flipped if face down (handled in render usually, but here logic)
                    // Actually if we click a face down card that is EXPOSED, we flip it.
                    // But standard solitaire flips automatically.
                    return;
                }

                if (!this.selected) {
                    if (type === 'tableau' || type === 'waste') {
                        this.selected = { type, colIdx, cardIdx, card };
                        this.render();
                    }
                } else {
                    // Try Move Selected -> Target
                    // Target is 'card'.
                    // Can we place selected on card?
                    // Rule: Target must be +1 rank and diff color.
                    // Selected must be King if Target is empty? (Handled in empty click)

                    if (this.selected.card.uid === card.uid) {
                        this.selected = null; // Deselect
                        this.render();
                        return;
                    }

                    if (this.isValidMove(this.selected.card, card)) {
                        this.executeMove(this.selected, { type, colIdx });
                    } else {
                        // Change selection
                        this.selected = { type, colIdx, cardIdx, card };
                        this.render();
                    }
                }
            }

            clickEmptyTableau(colIdx) {
                if (!this.selected) return;
                // Only Kings
                if (this.selected.card.val === 13) {
                    this.executeMove(this.selected, { type: 'tableau', colIdx });
                }
            }

            clickFoundation(fIdx) {
                if (!this.selected) {
                    // Maybe select FROM foundation? Not standard strategy often needed but allowed.
                    return;
                }

                // Move TO foundation
                let card = this.selected.card;
                let pile = this.foundations[fIdx];
                let top = pile.length > 0 ? pile[pile.length - 1] : null;

                let valid = false;
                if (!top) {
                    if (card.val === 1) valid = true; // Ace
                } else {
                    if (card.suit === top.suit && card.val === top.val + 1) valid = true;
                }

                if (valid) {
                    // Determine where card came from and splice it
                    // Foundation only accepts SINGLE cards, not stacks.
                    // Tableau selection might be a stack.
                    // If moving from tableau, ensure it is the TOP card.
                    let isTop = true;
                    if (this.selected.type === 'tableau') {
                        let tCol = this.tableau[this.selected.colIdx];
                        if (this.selected.cardIdx !== tCol.length - 1) isTop = false;
                    }

                    if (isTop) {
                        this.moveCardToFoundation(this.selected, fIdx);
                    }
                }
            }

            isValidMove(card, target) {
                if (card.color !== target.color && card.val === target.val - 1) return true;
                return false;
            }

            executeMove(from, to) {
                // Move stack
                let stack = [];
                if (from.type === 'waste') {
                    stack = [this.waste.pop()];
                } else if (from.type === 'tableau') {
                    let col = this.tableau[from.colIdx];
                    stack = col.splice(from.cardIdx); // Take all from idx
                    // Reveal new top
                    if (col.length > 0) col[col.length - 1].faceUp = true;
                }

                // Add to dest
                if (to.type === 'tableau') {
                    this.tableau[to.colIdx].push(...stack);
                }

                this.score += 10;
                this.addMove();
                this.selected = null;
                this.render();
            }

            moveCardToFoundation(from, fIdx) {
                let card;
                if (from.type === 'waste') card = this.waste.pop();
                else if (from.type === 'tableau') {
                    let col = this.tableau[from.colIdx];
                    card = col.pop();
                    if (col.length > 0) col[col.length - 1].faceUp = true;
                }

                this.foundations[fIdx].push(card);
                this.score += 100;
                this.addMove();
                this.selected = null;
                this.checkWin();
                this.render();
            }

            addMove() {
                this.moves++;
                document.getElementById('moves').innerText = this.moves;
                document.getElementById('score').innerText = this.score;
            }

            checkWin() {
                if (this.foundations.every(f => f.length === 13)) {
                    document.getElementById('winScreen').style.display = 'flex';
                    if (typeof GameHubAudio !== 'undefined') GameHubAudio.play('win');
                }
            }

            showHint() {
                // Determine best move
                // Priority: Waste -> Foundation, Tableau -> Foundation, Tableau -> Tableau (Reveal Card), Waste -> Tableau
                let hint = "No clear moves.";

                // Check Waste -> Foundation
                if (this.waste.length > 0) {
                    let c = this.waste[this.waste.length - 1];
                    for (let i = 0; i < 4; i++) {
                        let top = this.foundations[i].length > 0 ? this.foundations[i][this.foundations[i].length - 1] : null;
                        if (!top && c.val === 1) { alert("HINT: Move Ace from Waste to Foundation."); return; }
                        if (top && c.suit === top.suit && c.val === top.val + 1) { alert("HINT: Move " + c.rank + c.suit + " from Waste to Foundation."); return; }
                    }
                }

                // Check Tableau -> Foundation
                for (let i = 0; i < 7; i++) {
                    if (this.tableau[i].length === 0) continue;
                    let c = this.tableau[i][this.tableau[i].length - 1];
                    for (let f = 0; f < 4; f++) {
                        let top = this.foundations[f].length > 0 ? this.foundations[f][this.foundations[f].length - 1] : null;
                        if ((!top && c.val === 1) || (top && c.suit === top.suit && c.val === top.val + 1)) {
                            alert("HINT: Move " + c.rank + c.suit + " from Col " + (i + 1) + " to Foundation."); return;
                        }
                    }
                }

                // Check Waste -> Tableau
                if (this.waste.length > 0) {
                    let c = this.waste[this.waste.length - 1];
                    for (let i = 0; i < 7; i++) {
                        if (this.tableau[i].length === 0) { if (c.val === 13) { alert("HINT: Move King from Waste to Empty Col " + (i + 1)); return; } continue; }
                        let top = this.tableau[i][this.tableau[i].length - 1];
                        if (this.isValidMove(c, top)) { alert("HINT: Move " + c.rank + c.suit + " from Waste to Col " + (i + 1)); return; }
                    }
                }

                alert(hint);
            }

            // --- Rendering ---

            createCardHTML(card, isSelected, onClickStr) {
                if (!card.faceUp) {
                    // allow clicking face down? No logic for it yet
                    // Wait, sometimes we click face down stock? That's separate.
                    return `<div class="card back" style="top:0px" onclick="${onClickStr}"></div>`;
                }

                let classes = `card ${card.color} ${isSelected ? 'selected' : ''}`;
                return `
                <div class="${classes}" onclick="${onClickStr}">
                    <div class="card-top">
                        <span>${card.rank}</span>
                        <span>${card.suit}</span>
                    </div>
                    <div class="card-center">${card.suit}</div>
                    <div class="card-bottom">
                         <span>${card.rank}</span>
                        <span>${card.suit}</span>
                    </div>
                </div>`;
            }

            render() {
                // Stock
                let stockHTML = this.stock.length > 0 ? `<div class="card back"></div>` : `<div style="color:rgba(255,255,255,0.2); font-size:30px; line-height:112px; text-align:center">↺</div>`;
                document.getElementById('stockSlot').innerHTML = stockHTML;

                // Waste
                let wasteHTML = '';
                if (this.waste.length > 0) {
                    let c = this.waste[this.waste.length - 1];
                    let sel = this.selected && this.selected.type === 'waste' && this.selected.card === c;
                    wasteHTML = this.createCardHTML(c, sel, `game.clickCard('waste', 0, 0)`);
                }
                document.getElementById('wasteSlot').innerHTML = wasteHTML;

                // Foundations
                this.foundations.forEach((pile, i) => {
                    let html = '';
                    if (pile.length > 0) {
                        html = this.createCardHTML(pile[pile.length - 1], false, `game.clickFoundation(${i})`);
                    }
                    document.getElementById('foundation' + i).innerHTML = html;
                });

                // Tableau
                let tContainer = document.getElementById('tableauContainer');
                tContainer.innerHTML = '';

                this.tableau.forEach((col, cIdx) => {
                    let colEl = document.createElement('div');
                    colEl.style.position = 'absolute';
                    colEl.style.left = (cIdx * 100) + 'px'; // 80w + 20gap
                    colEl.style.width = '80px';
                    colEl.style.height = '100%';

                    // Empty Base
                    let base = document.createElement('div');
                    base.className = 'slot';
                    base.style.top = '0px';
                    base.onclick = () => this.clickEmptyTableau(cIdx);
                    colEl.appendChild(base);

                    // Cards
                    col.forEach((card, rIdx) => {
                        let wrap = document.createElement('div');
                        wrap.style.position = 'absolute';
                        wrap.style.top = (rIdx * 25) + 'px'; // Fan out

                        let sel = this.selected && this.selected.type === 'tableau' &&
                            this.selected.colIdx === cIdx && this.selected.card === card;

                        // Pass index
                        wrap.innerHTML = this.createCardHTML(card, sel, `game.clickCard('tableau', ${cIdx}, ${rIdx})`);
                        colEl.appendChild(wrap);
                    });

                    tContainer.appendChild(colEl);
                });
            }
        }

        const game = new Solitaire();
    </script>
</body>

</html>